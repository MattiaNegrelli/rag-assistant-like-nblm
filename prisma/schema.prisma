generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  
  users     User[]
  documents Document[]
  chunks    DocumentChunk[]
  conversations Conversation[]
}

model Conversation {
  id          String   @id @default(uuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  
  title       String   @default("New Chat")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt // Used for sorting sidebar
  
  messages    Message[]
  
  @@index([workspaceId])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  role           String // "user" or "assistant"
  content        String
  sources        Json?  // Storing source citations
  
  createdAt      DateTime @default(now())
  
  @@index([conversationId])
}

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  role        String    @default("ADMIN") // MVP simplified
  
  createdAt   DateTime  @default(now())
}

model Document {
  id          String   @id @default(uuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  
  filename     String
  originalName String
  storageUrl   String
  status       String   @default("PENDING") // PENDING, PROCESSING, READY, ERROR
  pageCount    Int      @default(0)
  
  chunks       DocumentChunk[]
  
  createdAt    DateTime @default(now())
  
  @@index([workspaceId])
}

model DocumentChunk {
  id          String   @id @default(uuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id]) // Denormalized for fast filtering
  
  pageNumber  Int
  chunkIndex  Int
  content     String
  
  // Supported by compatible Prisma logic + raw queries
  embedding   Unsupported("vector(1536)")?

  createdAt   DateTime @default(now())

  @@index([workspaceId])
  @@index([documentId])
  // Vector index creation is usually done via raw SQL migration "CREATE INDEX ... ON ... USING hnsw ..."
}
